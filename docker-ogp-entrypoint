#!/bin/bash
set -e

# Generate OGP Config
CONFIG_FILE="$APACHE_DOCUMENT_ROOT/includes/config.inc.php"
echo "<?php" > ${CONFIG_FILE}
echo "# THIS IS AUTOGENERATED BY THE ENTRYPOINT" >> ${CONFIG_FILE}
echo "# THIS WILL BE OVERWRITTEN WHEN CONTAINER IS RESTARTED." >> ${CONFIG_FILE}
echo "#######################################################" >> ${CONFIG_FILE}
echo "\$db_host=\"$MYSQL_HOST\";" >> ${CONFIG_FILE}
echo "\$db_user=\"$MYSQL_USER\";" >> ${CONFIG_FILE}
echo "\$db_pass=\"$MYSQL_PASSWORD\";" >> ${CONFIG_FILE}
echo "\$db_name=\"$MYSQL_DATABASE\";" >> ${CONFIG_FILE}
echo "\$table_prefix="ogp_";" >> ${CONFIG_FILE}
echo "\$db_type="mysql";" >> ${CONFIG_FILE}
echo "?>" >> ${CONFIG_FILE}


# Install extras
EXTRAS_FOLDER="/tmp/extras"
if [ ! "$EXTRAS_REPO" == "none" ]; then
    git clone $EXTRAS_REPO $EXTRAS_FOLDER
    if [ -f "$EXTRAS_FOLDER/run.sh" ]; then
        chmod +x "$EXTRAS_FOLDER/run.sh"
	sh "$EXTRAS_FOLDER/run.sh"
    fi
    cp -r $EXTRAS_FOLDER/* $APACHE_DOCUMENT_ROOT
    chown -R $APACHE_RUN_USER:$APACHE_RUN_GROUP $APACHE_DOCUMENT_ROOT
    rm -rf $EXTRAS_FOLDER
fi


# Clean HTTP file directory
if [ -f "$APACHE_DOCUMENT_ROOT/run.sh" ]; then
    rm "$APACHE_DOCUMENT_ROOT/run.sh"
fi
if [ -f "$APACHE_DOCUMENT_ROOT/install.php" ]; then
    rm -rf "$APACHE_DOCUMENT_ROOT/install.php"
fi

# first arg is `-f` or `--some-option`
if [ "${1#-}" != "$1" ]; then
	set -- apache2-foreground "$@"
fi

exec "$@"
